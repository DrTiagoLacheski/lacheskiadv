{% extends "base_ferramentas.html" %}

{% block title %}Formulário de Habilitação Processual{% endblock %}

{% block styles %}
    {{ super() }}
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        .container-habilitacao {
            background: #fff;
            padding: 2.2em 2.5em 2.1em 2.5em;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,60,140,0.09), 0 1.5px 6px rgba(0,0,30,0.03);
            max-width: 410px;
            width: 100%;
            margin: 2em auto;
            animation: fadeIn 0.8s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98);}
            to { opacity: 1; transform: scale(1);}
        }
        h2 {
            margin-bottom: 1.3em;
            font-weight: 500;
            color: #263159;
            font-size: 1.42em;
            text-align: center;
            letter-spacing: 0.01em;
        }
        label {
            display: block;
            margin-bottom: 0.2em;
            font-weight: 500;
            color: #3a4767;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 0.62em 0.85em;
            margin-bottom: 1.1em;
            border: 1.5px solid #cfd8dc;
            border-radius: 6px;
            font-size: 1em;
            background: #f7fbff;
            transition: border 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            border-color: #4f8aff;
            outline: none;
            background: #f0f6ff;
        }
        .error-message {
            color: #e74c3c;
            font-size: 0.97em;
            margin-top: -0.8em;
            margin-bottom: 1em;
            display: none;
        }
        button {
            width: 100%;
            background: linear-gradient(90deg, #3b82f6 60%, #06b6d4 100%);
            color: #fff;
            border: none;
            padding: 0.95em 1.3em;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.08em;
            font-weight: 500;
            box-shadow: 0 1.5px 7px rgba(60,100,200,0.08);
            transition: background 0.18s, box-shadow 0.18s;
        }
        button:hover, button:focus {
            background: linear-gradient(90deg, #2563eb 60%, #0891b2 100%);
            box-shadow: 0 3px 16px rgba(60,100,200,0.12);
        }
        .btn-voltar {
            background: #e0e7ef;
            color: #263159;
            font-weight: 500;
            margin-top: 0.7em;
            margin-bottom: 0.5em;
            border: none;
            box-shadow: none;
            transition: background 0.18s, color 0.18s;
        }
        .btn-voltar:hover, .btn-voltar:focus {
            background: #c1d1e7;
            color: #1846b2;
        }
        @media (max-width: 500px) {
            .container-habilitacao {padding: 1.2em;}
            h2 {font-size: 1.1em;}
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container-habilitacao">

        <form method="POST" autocomplete="off" id="habilitacao-form" action="{{ url_for('habilitacao.pagina_habilitacao') }}">
            <h2>Habilitação Processual</h2>
            <label for="endereco">Endereçamento:</label>
            <input type="text" id="endereco" name="endereco" required
                   placeholder="Ex: Ao Juízo da 10ª Vara Cível da Comarca de São Paulo">

            <label for="numero_processo">Número do Processo:</label>
            <input type="text" id="numero_processo" name="numero_processo" required maxlength="25"
                   pattern="\d{7}-\d{2}\.\d{4}\.\d\.\d{2}\.\d{4}"
                   placeholder="Ex: 0001234-56.2023.8.26.0001"
                   title="Formato: NNNNNNN-DD.AAAA.J.TR.OOOO">
            <div class="error-message" id="error-numero-processo">
                Informe o número do processo no formato correto: 0001234-56.2023.8.26.0001
            </div>

            <label for="nome_cliente">Nome do Cliente:</label>
            <input type="text" id="nome_cliente" name="nome_cliente" required
                   placeholder="Ex: Maria da Silva">

            {% if oabs|length > 1 %}
                <label for="oab_idx" style="margin-top:1em; font-weight:600;">Escolha a OAB a ser usada:</label>
                <select name="oab_idx" id="oab_idx" required
                        style="width:100%;padding:0.65em 0.85em;border-radius:6px;border:1.5px solid #cfd8dc;font-size:1em;margin-bottom:1em;background:#f7fbff;">
                    {% set pre_selected = false %}
                    {% for oab in oabs %}
                        {% set uf = (oab.uf if oab.uf is defined else (oab.numero.split('/')[-1].strip() if '/' in oab.numero else '')) %}
                        <option value="{{ loop.index0 }}"
                                {% if not pre_selected and uf|upper == "RO" %}{% set pre_selected = true %}selected{% endif %}>
                            OAB/{{ oab.uf }} n° {{ oab.numero }}
                        </option>
                    {% endfor %}
                </select>
            {% elif oabs|length == 1 %}
                <input type="hidden" name="oab_idx" value="0">
            {% endif %}

            <button type="submit">Gerar PDF</button>
            <button type="button" class="btn-voltar" onclick="window.history.back()">&larr; Voltar</button>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    <script>
    // Função de máscara dinâmica para o número do processo CNJ
    function maskProcessoCNJ(value) {
        value = value.replace(/\D/g, '');
        if (value.length > 7)
            value = value.replace(/^(\d{7})(\d)/, "$1-$2");
        if (value.length > 10)
            value = value.replace(/^(\d{7}-\d{2})(\d)/, "$1.$2");
        if (value.length > 15)
            value = value.replace(/^(\d{7}-\d{2}\.\d{4})(\d)/, "$1.$2");
        if (value.length > 17)
            value = value.replace(/^(\d{7}-\d{2}\.\d{4}\.\d)(\d)/, "$1.$2");
        if (value.length > 20)
            value = value.replace(/^(\d{7}-\d{2}\.\d{4}\.\d\.\d{2})(\d)/, "$1.$2");
        return value.substring(0,25);
    }

    function validarProcesso(str) {
        return /^(\d{7}-\d{2}\.\d{4}\.\d\.\d{2}\.\d{4})$/.test(str.trim());
    }

    document.addEventListener('DOMContentLoaded', function() {
        var form = document.getElementById('habilitacao-form');
        var inputProcesso = document.getElementById('numero_processo');
        var errorMsg = document.getElementById('error-numero-processo');

        inputProcesso.addEventListener('input', function(e) {
            var masked = maskProcessoCNJ(inputProcesso.value);
            inputProcesso.value = masked;
            var newLength = masked.length;
            inputProcesso.setSelectionRange(newLength, newLength);

            if (validarProcesso(masked)) {
                errorMsg.style.display = 'none';
            }
        });

        form.addEventListener('submit', function(e) {
            errorMsg.style.display = 'none';
            if (!validarProcesso(inputProcesso.value)) {
                errorMsg.style.display = 'block';
                inputProcesso.focus();
                e.preventDefault();
            }
        });
    });
    </script>
{% endblock %}