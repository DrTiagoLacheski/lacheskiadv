{% extends "base.html" %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/visualizar_artigo.css') }}">
    <style>
        .article-attachments-section {
            margin: 32px 0 24px 0;
            padding: 16px 18px 10px 18px;
            background: #f7f7fa;
            border-radius: 7px;
            border: 1px solid #ececef;
        }
        .article-attachments-section h3 {
            font-size: 1.16em;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .article-attachments-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .article-attachments-list li {
            margin: 0 0 7px 0;
            padding: 0;
            display: flex;
            align-items: center;
        }
        .article-attachments-list a {
            color: #2557a7;
            text-decoration: underline;
            margin-left: 8px;
        }
        .attachment-icon {
            display: inline-block;
            width: 20px; height: 20px; vertical-align: middle;
        }
    </style>
{% endblock %}

{% block content %}
<article class="article-page">

    {# Botão de voltar para o painel gerenciador (no topo) #}
    <div class="back-button-container" style="margin-bottom: 24px;">
        <a href="{{ url_for('main.painel_gerenciador') }}" class="btn btn-secondary btn-back">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5"></path>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            <span>Voltar ao Painel</span>
        </a>
    </div>

    {# 1. Cabeçalho com Título e Metadados #}
    <header class="article-header">
        <div class="header-content">
            {% if artigo.tags %}
            <div class="article-category">{{ artigo.tags.split(',')[0] }}</div>
            {% endif %}

            <h1 class="article-main-title">{{ artigo.titulo }}</h1>

            <div class="article-meta-detailed">
                <div class="author-info">
                    <img src="{{ url_for('static', filename='avatars/' + (artigo.autor.avatar or 'default.png')) }}" alt="Avatar de {{ artigo.autor.username }}" class="author-avatar">
                    <span>Por <strong>{{ artigo.autor.username }}</strong></span>
                </div>
                <span class="publish-date">Publicado em {{ artigo.criado_em.strftime('%d de %B de %Y') }}</span>
            </div>
        </div>
    </header>

    {# 2. Imagem de Capa em Destaque #}
    {% if artigo.imagem_capa %}
    <figure class="article-cover-figure">
        <img src="{{ url_for('static', filename='uploads/' + artigo.imagem_capa) }}" alt="Capa do artigo: {{ artigo.titulo }}">
    </figure>
    {% endif %}

    {# 3. Corpo do Artigo com Largura Otimizada e Compartilhamento #}
    <div class="article-body-wrapper">
        <div class="article-body">
            {{ artigo.conteudo|safe }}
        </div>

        {# 4. Se houver anexos, mostra a seção de anexos para download #}
        {% set lista_de_anexos = artigo.anexos.all() if artigo.anexos else [] %}
        {% if lista_de_anexos|length > 0 %}
            <section class="article-attachments-section">
                <h3>Anexos disponíveis para download</h3>
                <ul class="article-attachments-list">
                    {% for anexo in lista_de_anexos %}
                        <li>
            <span class="attachment-icon">
                <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                    <path d="M14.5 11V6.5C14.5 4.01472 12.4853 2 10 2C7.51472 2 5.5 4.01472 5.5 6.5V13C5.5 14.3807 6.61929 15.5 8 15.5C9.38071 15.5 10.5 14.3807 10.5 13V7.5"
                          stroke="#2557a7" stroke-width="1.3" stroke-linecap="round"/>
                </svg>
            </span>
                            <a href="{{ url_for('static', filename='uploads/' + anexo.filename) }}" download>
                                {{ anexo.filename }}
                            </a>
                            {% if anexo.descricao %}
                                <small style="color:#666; margin-left:10px;">{{ anexo.descricao }}</small>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </section>
        {% endif %}

    {# 5. Biografia do Autor #}
    <section class="author-bio-box">
        <img src="{{ url_for('static', filename='avatars/' + (artigo.autor.avatar or 'default.png')) }}" alt="Avatar de {{ artigo.autor.username }}" class="author-avatar-large">
        <div class="author-bio-content">
            <h4>Sobre {{ artigo.autor.username }}</h4>
            <p>{{ artigo.autor.bio or 'Entusiasta de tecnologia e conteúdo.' }}</p>
        </div>
    </section>

    {# 6. Artigos Relacionados #}
    {% if related_artigos %}
    <section class="related-articles-section">
        <h2>Continue Lendo</h2>
        <div class="articles-grid">
            {% for related in related_artigos %}
            <div class="article-card">
                 <a href="{{ url_for('main.visualizar_artigo', artigo_id=related.id) }}">
                    {% if related.imagem_capa %}
                        <img src="{{ url_for('static', filename='uploads/' + related.imagem_capa) }}" alt="Capa" class="article-cover-image">
                    {% endif %}
                    <div class="article-content">
                        <h3 class="article-title">{{ related.titulo }}</h3>
                        <p class="article-snippet">{{ related.conteudo|striptags|truncate(80) }}</p>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {# Botão de voltar para o painel gerenciador (no final) #}
    <div class="back-button-container" style="margin: 40px 0 0 0; text-align: center;">
        <a href="{{ url_for('main.painel_gerenciador') }}" class="btn btn-secondary btn-back">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5"></path>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            <span>Voltar ao Painel</span>
        </a>
    </div>

</article>
{% endblock %}