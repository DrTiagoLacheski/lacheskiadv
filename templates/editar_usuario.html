{% extends "base_m.html" %}
{% block title %}Alterar Dados do Usuário e Advogado{% endblock %}
{% block content %}
<div class="card mb-4">
    <div class="card-header"><h2>Alterar dados do usuário</h2></div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('user.editar_usuario', user_id=usuario.id) }}">
            <div class="mb-3">
                <label for="username" class="form-label">Nome de usuário</label>
                <input type="text" class="form-control" id="username" name="username"
                    value="{{ usuario.username }}" required maxlength="64"
                    {% if not (current_user.id == usuario.id or (current_user.is_admin and (usuario.admin_id == current_user.id or usuario.is_admin))) %}readonly{% endif %}>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Nova Senha</label>
                <input type="password" class="form-control" id="password" name="password" minlength="6">
            </div>
            <div class="mb-3">
                <label for="password_confirm" class="form-label">Confirme a Nova Senha</label>
                <input type="password" class="form-control" id="password_confirm" name="password_confirm" minlength="6">
                <small class="form-text text-muted">Digite novamente a nova senha.</small>
            </div>
            <button type="submit" class="btn btn-primary">Salvar dados</button>
        </form>
    </div>
</div>

<!-- INFORMAÇÕES DO USUÁRIO E ADMIN -->
<div class="card mb-4">
    <div class="card-header"><h3>Informações do Usuário</h3></div>
    <div class="card-body">
        <p><strong>Nome de usuário:</strong> {{ usuario.username }}</p>
        <p><strong>E-mail:</strong> {{ usuario.email }}</p>
        <p><strong>Tipo de usuário:</strong> {% if usuario.is_admin %}Administrador{% else %}Associado{% endif %}</p>
        {% if usuario.admin_id and usuario.admin %}
            <p><strong>Admin responsável:</strong> {{ usuario.admin.username }} (ID: {{ usuario.admin_id }})</p>
        {% endif %}
        <hr>
        {% if usuario.is_admin %}
        <h5>Advogados do Administrador</h5>
        {% if advogados|length > 0 %}
            <div class="accordion mb-3" id="accordionAdvAdmin">
                {% for advogado in advogados %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingAdmin{{ advogado.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdmin{{ advogado.id }}" aria-expanded="false" aria-controls="collapseAdmin{{ advogado.id }}">
                            {{ advogado.nome }} - {{ advogado.profissao }} (CPF: {{ advogado.cpf }})
                        </button>
                    </h2>
                    <div id="collapseAdmin{{ advogado.id }}" class="accordion-collapse collapse" aria-labelledby="headingAdmin{{ advogado.id }}" data-bs-parent="#accordionAdvAdmin">
                        <div class="accordion-body">
                            <form method="POST" action="{{ url_for('user.editar_advogado', advogado_id=advogado.id) }}">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label for="nome_{{ advogado.id }}" class="form-label">Nome Completo</label>
                                        <input type="text" class="form-control" id="nome_{{ advogado.id }}" name="nome" value="{{ advogado.nome }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="estado_civil_{{ advogado.id }}" class="form-label">Estado Civil</label>
                                        <input type="text" class="form-control" id="estado_civil_{{ advogado.id }}" name="estado_civil" value="{{ advogado.estado_civil }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="profissao_{{ advogado.id }}" class="form-label">Profissão</label>
                                        <input type="text" class="form-control" id="profissao_{{ advogado.id }}" name="profissao" value="{{ advogado.profissao }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="cpf_{{ advogado.id }}" class="form-label">CPF</label>
                                        <input type="text" class="form-control" id="cpf_{{ advogado.id }}" name="cpf" value="{{ advogado.cpf }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="rg_{{ advogado.id }}" class="form-label">RG</label>
                                        <input type="text" class="form-control" id="rg_{{ advogado.id }}" name="rg" value="{{ advogado.rg }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="orgao_emissor_{{ advogado.id }}" class="form-label">Órgão Emissor</label>
                                        <input type="text" class="form-control" id="orgao_emissor_{{ advogado.id }}" name="orgao_emissor" value="{{ advogado.orgao_emissor }}">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">OAB(s) <span class="text-muted">(adicione todas as OABs deste advogado)</span></label>
                                        <div id="oabs-list-{{ advogado.id }}">
                                            {% if advogado.oabs %}
                                                {% for oab in advogado.oabs %}
                                                    <div class="input-group mb-1 oab-input-row">
                                                        <input type="text" class="form-control" name="oab_numero[]" value="{{ oab.numero }}" placeholder="Número da OAB (ex: 12345/PR)">
                                                        <button type="button" class="btn btn-outline-danger btn-remove-oab">Remover</button>
                                                    </div>
                                                {% endfor %}
                                            {% endif %}
                                            <!-- Campo extra vazio para adicionar nova OAB -->
                                            <div class="input-group mb-1 oab-input-row">
                                                <input type="text" class="form-control" name="oab_numero[]" value="" placeholder="Adicionar nova OAB">
                                                <button type="button" class="btn btn-outline-danger btn-remove-oab">Remover</button>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-success btn-add-oab mt-1" data-adv-id="{{ advogado.id }}">Adicionar OAB</button>
                                    </div>
                                    <div class="col-md-12">
                                        <label for="endereco_profissional_{{ advogado.id }}" class="form-label">Endereço Profissional</label>
                                        <input type="text" class="form-control" id="endereco_profissional_{{ advogado.id }}" name="endereco_profissional" value="{{ advogado.endereco_profissional }}">
                                    </div>
                                    <div class="col-md-12">
                                        <label for="is_principal_{{ advogado.id }}" class="form-label">Principal</label>
                                        <select class="form-control" id="is_principal_{{ advogado.id }}" name="is_principal">
                                            <option value="1" {% if advogado.is_principal %}selected{% endif %}>Sim</option>
                                            <option value="0" {% if not advogado.is_principal %}selected{% endif %}>Não</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success mb-2 mt-2">Salvar Advogado</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p>Não há informações de advogado para este admin.</p>
        {% endif %}
        <hr>
        {% endif %}
        <h5>Dados do Advogado Vinculado ao Usuário</h5>
        {% if not usuario.is_admin %}
            {% if usuario.advogados.count() > 0 %}
                <div class="accordion mb-3" id="accordionAdvUser">
                    {% for advogado in usuario.advogados %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingUser{{ advogado.id }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUser{{ advogado.id }}" aria-expanded="false" aria-controls="collapseUser{{ advogado.id }}">
                                {{ advogado.nome }} - {{ advogado.profissao }} (CPF: {{ advogado.cpf }})
                            </button>
                        </h2>
                        <div id="collapseUser{{ advogado.id }}" class="accordion-collapse collapse" aria-labelledby="headingUser{{ advogado.id }}" data-bs-parent="#accordionAdvUser">
                            <div class="accordion-body">
                                <form method="POST" action="{{ url_for('user.editar_advogado', advogado_id=advogado.id) }}">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label for="nome_{{ advogado.id }}" class="form-label">Nome Completo</label>
                                            <input type="text" class="form-control" id="nome_{{ advogado.id }}" name="nome" value="{{ advogado.nome }}" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="estado_civil_{{ advogado.id }}" class="form-label">Estado Civil</label>
                                            <input type="text" class="form-control" id="estado_civil_{{ advogado.id }}" name="estado_civil" value="{{ advogado.estado_civil }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="profissao_{{ advogado.id }}" class="form-label">Profissão</label>
                                            <input type="text" class="form-control" id="profissao_{{ advogado.id }}" name="profissao" value="{{ advogado.profissao }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="cpf_{{ advogado.id }}" class="form-label">CPF</label>
                                            <input type="text" class="form-control" id="cpf_{{ advogado.id }}" name="cpf" value="{{ advogado.cpf }}" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="rg_{{ advogado.id }}" class="form-label">RG</label>
                                            <input type="text" class="form-control" id="rg_{{ advogado.id }}" name="rg" value="{{ advogado.rg }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="orgao_emissor_{{ advogado.id }}" class="form-label">Órgão Emissor</label>
                                            <input type="text" class="form-control" id="orgao_emissor_{{ advogado.id }}" name="orgao_emissor" value="{{ advogado.orgao_emissor }}">
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">OAB(s) <span class="text-muted">(adicione todas as OABs deste advogado)</span></label>
                                            <div id="oabs-list-{{ advogado.id }}">
                                                {% if advogado.oabs %}
                                                    {% for oab in advogado.oabs %}
                                                        <div class="input-group mb-1 oab-input-row">
                                                            <input type="text" class="form-control" name="oab_numero[]" value="{{ oab.numero }}" placeholder="Número da OAB (ex: 12345/PR)">
                                                            <button type="button" class="btn btn-outline-danger btn-remove-oab">Remover</button>
                                                        </div>
                                                    {% endfor %}
                                                {% endif %}
                                                <!-- Campo extra vazio para adicionar nova OAB -->
                                                <div class="input-group mb-1 oab-input-row">
                                                    <input type="text" class="form-control" name="oab_numero[]" value="" placeholder="Adicionar nova OAB">
                                                    <button type="button" class="btn btn-outline-danger btn-remove-oab">Remover</button>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-outline-success btn-add-oab mt-1" data-adv-id="{{ advogado.id }}">Adicionar OAB</button>
                                        </div>
                                        <div class="col-md-12">
                                            <label for="endereco_profissional_{{ advogado.id }}" class="form-label">Endereço Profissional</label>
                                            <input type="text" class="form-control" id="endereco_profissional_{{ advogado.id }}" name="endereco_profissional" value="{{ advogado.endereco_profissional }}">
                                        </div>
                                        <div class="col-md-12">
                                            <label for="is_principal_{{ advogado.id }}" class="form-label">Principal</label>
                                            <select class="form-control" id="is_principal_{{ advogado.id }}" name="is_principal">
                                                <option value="1" {% if advogado.is_principal %}selected{% endif %}>Sim</option>
                                                <option value="0" {% if not advogado.is_principal %}selected{% endif %}>Não</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success mb-2 mt-2">Salvar Advogado</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>Não há informações de advogado para este usuário.</p>
            {% endif %}
        {% endif %}
    </div>
</div>

{% if usuario.is_admin and current_user.id == usuario.id %}
<div class="card mt-4">
    <div class="card-header">
        <h3>Associados deste Admin</h3>
        <small>Clique para editar dados do associado e seus advogados</small>
    </div>
    <div class="card-body">
        {% set associados = usuario.associados.all() %}
        {% if associados|length > 0 %}
            <div class="accordion" id="accordionAssociados">
                {% for associado in associados %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading{{ associado.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ associado.id }}" aria-expanded="false" aria-controls="collapse{{ associado.id }}">
                            {{ associado.username }} ({{ associado.email }}) [ID: {{ associado.id }}]
                        </button>
                    </h2>
                    <div id="collapse{{ associado.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ associado.id }}" data-bs-parent="#accordionAssociados">
                        <div class="accordion-body">
                            <form method="POST" action="{{ url_for('user.editar_usuario', user_id=associado.id) }}">
                                <div class="mb-3">
                                    <label for="username_{{ associado.id }}" class="form-label">Nome de usuário</label>
                                    <input type="text" class="form-control" id="username_{{ associado.id }}" name="username"
                                        value="{{ associado.username }}" required maxlength="64">
                                </div>
                                <button type="submit" class="btn btn-primary mb-2">Salvar nome de usuário do associado</button>
                            </form>
                            <hr>
                            <h6>Advogados do Associado</h6>
                            {% if associado.advogados.count() > 0 %}
                                {% for advogado in associado.advogados %}
                                    <form method="POST" action="{{ url_for('user.editar_advogado', advogado_id=advogado.id) }}">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <label for="nome_{{ advogado.id }}" class="form-label">Nome Completo</label>
                                                <input type="text" class="form-control" id="nome_{{ advogado.id }}" name="nome" value="{{ advogado.nome }}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="estado_civil_{{ advogado.id }}" class="form-label">Estado Civil</label>
                                                <input type="text" class="form-control" id="estado_civil_{{ advogado.id }}" name="estado_civil" value="{{ advogado.estado_civil }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="profissao_{{ advogado.id }}" class="form-label">Profissão</label>
                                                <input type="text" class="form-control" id="profissao_{{ advogado.id }}" name="profissao" value="{{ advogado.profissao }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="cpf_{{ advogado.id }}" class="form-label">CPF</label>
                                                <input type="text" class="form-control" id="cpf_{{ advogado.id }}" name="cpf" value="{{ advogado.cpf }}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="rg_{{ advogado.id }}" class="form-label">RG</label>
                                                <input type="text" class="form-control" id="rg_{{ advogado.id }}" name="rg" value="{{ advogado.rg }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="orgao_emissor_{{ advogado.id }}" class="form-label">Órgão Emissor</label>
                                                <input type="text" class="form-control" id="orgao_emissor_{{ advogado.id }}" name="orgao_emissor" value="{{ advogado.orgao_emissor }}">
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label">OAB(s) <span class="text-muted">(adicione todas as OABs deste advogado)</span></label>
                                                <div id="oabs-list-{{ advogado.id }}">
                                                    {% if advogado.oabs %}
                                                        {% for oab in advogado.oabs %}
                                                            <div class="input-group mb-1 oab-input-row">
                                                                <input type="text" class="form-control" name="oab_numero[]" value="{{ oab.numero }}" placeholder="Número da OAB (ex: 12345/PR)">
                                                                <button type="button" class="btn btn-outline-danger btn-remove-oab">Remover</button>
                                                            </div>
                                                        {% endfor %}
                                                    {% endif %}
                                                    <!-- Campo extra vazio para adicionar nova OAB -->
                                                    <div class="input-group mb-1 oab-input-row">
                                                        <input type="text" class="form-control" name="oab_numero[]" value="" placeholder="Adicionar nova OAB">
                                                        <button type="button" class="btn btn-outline-danger btn-remove-oab">Remover</button>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-outline-success btn-add-oab mt-1" data-adv-id="{{ advogado.id }}">Adicionar OAB</button>
                                            </div>
                                            <div class="col-md-12">
                                                <label for="endereco_profissional_{{ advogado.id }}" class="form-label">Endereço Profissional</label>
                                                <input type="text" class="form-control" id="endereco_profissional_{{ advogado.id }}" name="endereco_profissional" value="{{ advogado.endereco_profissional }}">
                                            </div>
                                            <div class="col-md-12">
                                                <label for="is_principal_{{ advogado.id }}" class="form-label">Principal</label>
                                                <select class="form-control" id="is_principal_{{ advogado.id }}" name="is_principal">
                                                    <option value="1" {% if advogado.is_principal %}selected{% endif %}>Sim</option>
                                                    <option value="0" {% if not advogado.is_principal %}selected{% endif %}>Não</option>
                                                </select>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-success mb-2 mt-2">Salvar Advogado</button>
                                    </form>
                                    <hr>
                                {% endfor %}
                            {% else %}
                                <p>Não há informações de advogado para este associado.</p>
                            {% endif %}
                        </div><!-- accordion-body -->
                    </div><!-- collapse -->
                </div><!-- accordion-item -->
                {% endfor %}
            </div>
        {% else %}
            <p>Não há associados vinculados a este admin.</p>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Adicionar campo nova OAB para todos advogados (admin, user, associados)
    document.querySelectorAll('.btn-add-oab').forEach(btn => {
        btn.addEventListener('click', function(e) {
            const advId = btn.getAttribute('data-adv-id');
            const wrapper = document.getElementById('oabs-list-' + advId);
            const row = document.createElement('div');
            row.className = 'input-group mb-1 oab-input-row';
            row.innerHTML = `
                <input type="text" class="form-control" name="oab_numero[]" value="" placeholder="Número da OAB (ex: 12345/PR)">
                <button type="button" class="btn btn-outline-danger btn-remove-oab">Remover</button>
            `;
            wrapper.appendChild(row);
        });
    });

    // Remover campo OAB para todos advogados
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('btn-remove-oab')) {
            // O wrapper é o <div id="oabs-list-...">, pai do input-row
            const wrapper = e.target.closest('.oab-input-row').parentElement;
            const rows = wrapper.querySelectorAll('.oab-input-row');
            if (rows.length > 1) {
                e.target.closest('.oab-input-row').remove();
            } else {
                e.target.closest('.oab-input-row').querySelector('input').value = '';
            }
        }
    });
});
</script>
{% endblock %}